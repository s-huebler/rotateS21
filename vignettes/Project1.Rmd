---
title: "Project 1: Recreation of Example 5.11"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Project1}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
options(rmarkdown.html_vignette.check_title = FALSE)

knitr::opts_chunk$set(
  collapse = TRUE,
  comment = ">",
  fig.align = "center"
)
```

```{r setup}
library(rotateS21)
library(car)
library(PlaneGeometry)
library(stats)

```

# The Goal

Automated welding machines are used for the assembly of automobile driveshafts. To make sure that a weld can be considered of good quality, the weld needs to be controlled within specific operating limits on 4 variables. The values of each variable were measured every 5 seconds until 40 observations were collected. The goal is to use this data to assess whether the variables are in control. We want to check using multivariate, bivariate, and univariate tests.

```{r}
welds <- read.table("../inst/df/T5-9.dat")
names(welds) <- c("Voltage", "Current", "Feed_Speed", "Gas_Flow")
head(welds)
```


# Normality 

We want to check the data for normality. The book suggests a log transformation for one of the variables. We can assess normality both before and after the transformation.

## Normality of Original Data

The first way to test for normality is to check univariate normality for all of the variables. This can be done using a shapiro wilks test. For this test the null hypothesis is normality, so a significant p-value indicates deviation from normality. The name of each varaible along with its shapiro test statistic and p-value are printed below.

```{r, echo=FALSE}
n1 <- apply(welds, 2, FUN=shapiro.test)


for(i in 1:4){
  lab <- names(n1)
  print( paste( lab[i], n1[[i]]$statistic, n1[[i]]$p.value, sep=" "))
}

```

We can see that the only p-value which is significant at a level of $\alpha=0.05$ is Gas_Flow. This tells us that this variable in not univariate normal. However, we cannot yet say whether the data is multivariate normal.

Next we can check for bivariate normality. We can visually assess bivariate normality by making an ellipse for each pair of variables. To form the ellipse we turn to the covariance matrix. The length of the major axis is the square root of the first eigenvalue of the covariance matrix and the direction is determined by the associated eigenvector. Similarly, the length of the mainor axis is the square root of the second eigenvalue of the covariance matrix and the direction is determined by the associated eigenvector.

```{r}
ellipseScatter(welds[,c(1,2)])
ellipseScatter(welds[,c(1,3)])
ellipseScatter(welds[,c(1,4)])
ellipseScatter(welds[,c(2,3)])
ellipseScatter(welds[,c(2,4)])
ellipseScatter(welds[,c(3,4)])
```

The bivariate normality does not seem suspicious for any pairs of variables. 

Finally, we can assess multivariate normality using a chi-square QQ-plot. We plot the ordered distance squared values for each observation on the y axis. The distance is calculated for each point as 

$$
d^2 = (\textbf{x}_j-\bar{\textbf{x}})'\textbf{S}^{-1}(\textbf{x}_j-\bar{\textbf{x}})
$$
Notice that this measurement is a scalar because the vector $(\textbf{x}_j-\bar{\textbf{x}})$ is a $4 \times 1$ vector that comes from centering each of the variables of the observation $j$. 

On the x axis we have the chi square quantiles of (j-0.5)/n for each j. The quantiles are calculated with the chi square distribution on p degrees of freedom where p is the number of columns in the data frame. If the data is distributed multivariate normal then we would expect our chi plot to follow a straight line at a 45 degree angle.

```{r}
chiPlot(welds)
```

The tail of the chi square plot does not look linear. This indicates a deviation from normality. Because of this, it is a good idea to try to transform the data. As the book suggests, we can use a log transformation on the gas flow variable since it was the only univariate non-normal variable. In the next section we perform the same multivariate normality tests on the transformed data. 

## Normality of Transformed Data

We can take the log transformation of the gas flow variable.

```{r}
weldT <- welds
weldT$Gas_Flow <- log(welds$Gas_Flow)

head(weldT)

```

Now we can perform the same univariate normality checks.


```{r}
n2 <- apply(weldT, 2, FUN=shapiro.test)


for(i in 1:4){
  lab <- names(n2)
  print( paste( lab[i], n2[[i]]$statistic, n2[[i]]$p.value, sep=" "))
}
```

As we can see, the test statistic and p-values of the 3 unchanged variables were unaffected by the transformation. The gas flow variable is still not normally distributed even with the new test statistic. This is an indication that a natural log transform may not be the best transformation. Examples of other transforms to try might be square root, box-cox, or arcsine.

Again we can look at the bivariate spread as well with the ellipses.

```{r}
ellipseScatter(weldT[,c(1,2)])
ellipseScatter(weldT[,c(1,3)])
ellipseScatter(weldT[,c(1,4)])
ellipseScatter(weldT[,c(2,3)])
ellipseScatter(weldT[,c(2,4)])
ellipseScatter(weldT[,c(3,4)])
```

The ellipses do not appear much different than they did with the untransformed data. However, log transformations are non linear, so the correlation between the variables has changed. 

Finally, we can assess multivariate normality using the chi qq plot. 
```{r}
chiPlot(weldT)
```
Again the chi qq plot is not visibly significantly different than the untransformed qq plot. This affirms the conclusion that the natural log transformation was not a good choice of transformations. Because the transformation is not useful, the rest of the analysis can be done with either the transformed or untransformed data. 

# Tsq Plot
A $T^2$ chart is a multivariate tool to assess whether observations are in control. Similar to the chi square qq plot, the values of the Tsq chart are calculated using the $d^2$ formula.

$$
T^2=d^2 = (\textbf{x}_j-\bar{\textbf{x}})'\textbf{S}^{-1}(\textbf{x}_j-\bar{\textbf{x}})
$$

This value is found for every observation and then plotted against a time series. Because we are plotting the squared distance, the lower control limit is 0. The upper control limit is the chi square quantile of the desired alpha value. Usually alpha is set at .05 or .01 to get 95% of 99% control limits. 

We can create this chart for our welder data because the welder data has an inherent time series ordering. Recall that observations were recorded every 5 seconds. 

```{r}
#tsq(weldT)
```

